const express = require("express");
const upload = require("express-fileupload");
const path = require("path");
const app = express();
app.use(upload());
app.use(express.static("public"));

app.get("/", (req, res) => {
	res.sendFile(__dirname + "/index.html");
});

app.post("/", (req, res) => {
	if (req.files) {
		var file = req.files.file;
		var filename = file.name;
		console.log(file);
		file.mv("./uploads/" + filename, function (err) {
			if (err) {
				res.send(err);
			} else {
				const { spawn } = require("child_process");
				const pythonProcess = spawn("python", ["script.py", filename]);
				console.log("pythonProcess");

				pythonProcess.stdout.on("data", (data) => {
					// Do something with the data returned from python script
					var buf = data;
					let temp = buf.toString().split("\n").join("");
					let ben = "benign";
					let mal = "malware";
					// console.log(temp);
					// console.log(temp.localeCompare(mal));
					// console.log(temp.localeCompare(ben));
					if (temp.localeCompare(mal) + temp.localeCompare(ben) == 0) {
						res.sendFile(__dirname + "/res_safe.html");
					}
					else if (temp.localeCompare(mal) + temp.localeCompare(ben) == 2) {
						res.sendFile(__dirname + "/res_mal.html");
					} else {
						res.sendFile(__dirname + "/error.html");
					}
				});
			}
		});
	}
});

app.listen(5000);
